flowchart TD
    A["İşveren Mesajı (Web UI)"] --> B["Telegram Bildirimi:<br/>Yeni mesaj geldi"]
    B --> C{"Keyword Risk Check<br/>(Regex, API çağrısı yok)"}
    C -->|"maaş/sözleşme/hukuk"| ESC["_escalate()"]
    C -->|"Temiz"| D{"LLM Gate Check<br/>(gate_agent.py)"}
    D -->|"can_respond: false"| ESC
    D -->|"can_respond: true"| E["Career Agent<br/>Profil + Prompt → Yanıt"]
    E --> F{"Evaluator Agent<br/>5 kriter × 0-100 puan"}
    F -->|"Skor < 70"| G["Feedback ile Revizyon<br/>(max 3 deneme)"]
    G --> E
    F -->|"Skor ≥ 70 (Onay)"| H["Telegram: Yanıt gönderildi ✅"]
    H --> I["Web UI: Yeşil Yanıt Kartı"]

    ESC --> J["escalation_store: pending"]
    J --> K["Telegram: ⚠️ İnsan Müdahalesi"]
    K --> L["Web UI: Sarı Bekleme Kartı<br/>(polling başlar)"]
    L --> M{"İnsan Telegram'da<br/>Reply ile cevap yazar"}
    M --> N["telegram_listener yakalır"]
    N --> O["LLM ile Profesyonelleştirme"]
    O --> P["escalation_store: resolved"]
    P --> Q["Telegram: ✅ Profesyonel yanıt"]
    Q --> R["Web UI: Yeşil Yanıt Kartı<br/>(polling ile güncellenir)"]

    style ESC fill:#f59e0b,stroke:#d97706,color:#000
    style I fill:#22c55e,stroke:#16a34a,color:#000
    style R fill:#22c55e,stroke:#16a34a,color:#000
    style K fill:#ef4444,stroke:#dc2626,color:#fff
